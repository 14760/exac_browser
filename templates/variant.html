{% extends "layout.html" %}
{% block body %}
    <!-- Render context vars in JS here -->
    <script type="text/javascript">
        window.variant = {{ variant|tojson|safe }};
        window.base_coverage = {{ base_coverage|tojson|safe }};
        window.any_covered = {{ any_covered|tojson|safe }};

        $(document).ready(function() {
{#            if (!window.variant) {#}
                draw_region_coverage(window.base_coverage, 'mean', window.variant.ref);
                $('.coverage_metric_buttons').change(function () {
                    var v = $(this).attr('id').replace('_covmet_button', '');
                    $('.coverage_subcat_selectors').hide();
                    if (v == 'covered') {
                        $('#over_x_select_container').show();
                        v = $('#over_x_select').val();
                    } else {
                        $('#average_select_container').show();
                        v = $("#average_select").val();
                    }
                    draw_region_coverage(window.base_coverage, v, window.variant.ref);
                });
                $('#over_x_select').change(function () {
                    draw_region_coverage(window.base_coverage, $(this).val(), window.variant.ref);
                });
                $('#average_select').change(function () {
                    draw_region_coverage(window.base_coverage, $(this).val(), window.variant.ref);
                });
{#            }#}
        });
    </script>
    <style>
    .d3_graph {
        font: 10px sans-serif;
    }

    .bar rect {
        fill: steelblue;
        shape-rendering: crispEdges;
    }

    .bar text {
        fill: #fff;
    }

    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    </style>
    <script>
        $(document).ready(function() {
            $('.frequency_display_buttons').change(function() {
                $('.frequency_displays').hide();
                var v = $(this).attr('id').replace('_button', '');
                $('#' + v + '_container').show();
            });
            $('#frequency_table').tablesorter({
                sortList: [[3,1], [0,0]]
            });

            if (window.variant != null && 'genotype_depths' in window.variant) {
                draw_quality_histogram(window.variant.genotype_depths);
                $('.quality_display_buttons').change(function() {
                    var v = $(this).attr('id').replace('_button', '');
                    var f = $('#quality_variant_sites_only_button').hasClass('active');
                    draw_quality_histogram(window.variant[v]);
                });
                $('#quality_variant_sites_only_button').click(function() {
                    var v = $('.quality_display_buttons.active').attr('id').replace('_button', '');
                    // TODO: Fix to do this properly
                    var f = !$(this).hasClass('active');
                    draw_quality_histogram(window.variant[v]);
                });
            } else {
                $('#quality_metrics_container').hide();
{#                $('#frequency_info_container').hide();#}
            }
        });
    </script>
    <div class="container">
        <h1>Variant: {{ variant.chrom }}:{{ variant.pos }} {{ variant.ref }} / {{ variant.alt }}</h1>
        <hr/>

        {% if variant.orig_alt_alleles|length > 1 %}
            <p><span class="label label-info">Note:</span> This variant is multiallelic! The other alt alleles are:</p>
            <ul>
                {% for allele in variant.orig_alt_alleles %}
                    {% if allele != variant.variant_id %}
                        <li>
                            <a href="/variant/{{ allele }}">{{ allele }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
            <hr/>
        {% endif %}

{#          Upper display #}
        {% if variant.allele_freq %}
            <div class="row">
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        {% if variant.rsid and variant.rsid != "." %}
                            <dt>Known variant</dt>
                            <dd><a href="http://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?rs={{ variant.rsid }}" target="_blank">{{ variant.rsid }}</a></dd>
                        {% endif %}
                        <dt>Allele Frequency</dt>
                        <dd>{{ variant.allele_freq }}</dd>
                        <dt>Allele Count</dt>
                        <dd>{{ variant.allele_count }} / {{ variant.allele_num }}</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Site Quality</dt>
                        <dd>{{ variant.site_quality }}</dd>
                        <dt>
                            {% if variant.filter != "PASS" %}
                                <span class="label label-danger">Filter Status</span>
                            {% else %}
                                Filter Status
                            {% endif %}
                        </dt>
                        <dd>{{ variant.filter }}</dd>
                    </dl>
                </div>
            </div>
            <hr/>
        {% endif %}

{#          Lower display#}
        <div class="row">
            <div class="col-md-6">
                <div id="annotation_container">
                    <div class="section_header">Annotations</div>
                    {% if variant.vep_annotations %}
                        <p>This variant falls on {{ variant.transcripts|length }} transcripts in {{ variant.genes|length }} genes:</p>
                        <div class="panel-group" id="annotation_accordion">
                            {% for consequence in consequences %}
                                <h4>{{ consequence }}</h4>
                                <ul>
                                    {% for gene in consequences[consequence] %}
                                        <li>
                                             <a href="/gene/{{ gene }}">
                                            {% if consequences[consequence][gene][0].SYMBOL %}
                                                {{ consequences[consequence][gene][0].SYMBOL }}
                                            {% else %}
                                                {{ gene }}
                                            {% endif %}
                                            </a>
                                        </li>
                                            <ul>
                                                {% for annotation in consequences[consequence][gene] %}
                                                    <li>
                                                         <a href="/transcript/{{ annotation.Feature }}">{{ annotation.Feature }}</a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                    {% endfor %}
                                </ul>
                            {% endfor %}
                        </div>
                    {% else %}
                        No annotations were found for this variant.
                    {% endif %}
                </div>
                <div id="browser_container">
                </div>
            </div>

            <div class="col-md-6">
                {% if variant.pop_acs %}
                    <div id="frequency_info_container">
                        <div class="section_header">Population Frequencies</div>
                        <div id="frequency_table_container" class="frequency_displays">
                            <table id="frequency_table">
                                <thead>
                                    <tr>
                                        <th>Population</th>
                                        <th>Allele Count</th>
                                        <th>Number of Homozygotes</th>
                                        <th>Allele Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pop in variant.pop_acs %}
                                        <tr>
                                            <td>{{ pop }}</td>
                                            <td>{{ variant.pop_acs[pop] }}</td>
                                            <td>{{ variant.pop_homs[pop] }}</td>
                                            {% if variant.pop_ans[pop] > 0 %}
                                                <td>{{ '%0.4g' % (variant.pop_acs[pop]/variant.pop_ans[pop]) }}</td>
                                            {% else %}
                                                <td>NA</td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td><b>Total</b></td>
                                        <td><b>{{ variant.pop_acs.values()|sum }}</b></td>
                                        <td><b>{{ variant.pop_homs.values()|sum }}</b></td>
                                        <td><b>{{ '%0.4g' % variant.allele_freq }}</b></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div id="quality_metrics_container">
                        <h3>Quality Metrics</h3>
    {#                    <button type="button" data-toggle="button" class="btn btn-primary" id="quality_variant_sites_only_button">#}
    {#                        Variants only#}
    {#                    </button>#}
                        <span class="btn-group" data-toggle="buttons" id="quality_display_button_group" style="float: right;">
                            <button class="btn btn-primary active quality_display_buttons" id="genotype_depths_button">
                                <input type="radio"> Depth
                            </button>
                            <button class="btn btn-primary quality_display_buttons" id="genotype_qualities_button">
                                <input type="radio" > Genotype Quality
                            </button>
                        </span>
                        <div id="quality_display_container" class="d3_graph"></div>
                    </div>
                {% else %}
                    {% if any_covered %}
                        <div class="row">
                            <span class="section_header">Coverage</span>
                            {% if base_coverage|length > 1 %}
                                {% include 'coverage_selectors.html' %}
                            {% endif %}
                        </div>
                        <div id="region_coverage"></div>
                    {% else %}
                        This region is not covered in the ExAC dataset.
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}